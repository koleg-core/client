variables:
  REGISTRY_AUTH_FILE: auth.json
  IMAGE_NAME: koleg-client

stages:
  - 🐳login
  - 🏗build
  - deploy

.docker_login:
  image: jbenden/buildah
  before_script:
   - |
    echo "$SCW_REGISTRY_TOKEN" \
     | buildah login -u "$SCW_REGISTRY_USER" --password-stdin $SCW_REGISTRY

🔥build_prod:
  stage: 🏗build
  extends: .docker_login
  script: |
    buildah bud \
      --storage-driver "vfs" \
      --build-arg='PROD=false' \
      -t $IMAGE_NAME .
    echo "Push image to registry"
    buildah push \
      $IMAGE_NAME \
      docker://$SCW_REGISTRY/$IMAGE_NAME:latest
    buildah push \
      $IMAGE_NAME \
      docker://SCW_REGISTRY/$IMAGE_NAME:${CI_COMMIT_SHA}

🚑build_debug:
  stage: 🏗build
  extends: .docker_login
  script: |
    buildah bud \
      --storage-driver "vfs" \
      --build-arg='PROD=false' \
      -t $IMAGE_NAME .
    echo "Push image to registry"
    buildah push \
      $IMAGE_NAME \
      docker://$SCW_REGISTRY/$IMAGE_NAME:debug
    buildah push \
      $IMAGE_NAME \
      docker://$SCW_REGISTRY/$IMAGE_NAME:debug-${CI_COMMIT_SHA}
