variables:
  BUILDAH_FORMAT: docker
  REGISTRY_AUTH_FILE: auth.json
  IMAGE_NAME: koleg-client

stages:
  - 🐳login
  - 🏗build
  - 🔖release
  - deploy

.docker_login:
  image: buildah/buildah:latest
  before_script:
   - >
     echo "$SCW_REGISTRY_TOKEN"
     | buildah login -u "$SCW_REGISTRY_USER" --password-stdin $SCW_REGISTRY

🔥build_prod:
  stage: 🏗build
  extends: .docker_login
  script: |
    buildah bud \
      --storage-driver "vfs" \
      --build-arg='PROD=true' \
      -t $SCW_REGISTRY/$IMAGE_NAME:${CI_COMMIT_SHA} \
      -t $SCW_REGISTRY/$IMAGE_NAME:latest .

🔥release_prod:
  stage: 🔖release
  extends: .docker_login
  script: |
    export STORAGE_DRIVER
    buildah push \
      $SCW_REGISTRY/$IMAGE_NAME:latest \
      $SCW_REGISTRY/$IMAGE_NAME:${CI_COMMIT_SHA}

🚑build_debug:
  stage: 🏗build
  extends: .docker_login
  script: |
    buildah bud \
      --storage-driver "vfs" \
      --build-arg='PROD=false' \
      -t $SCW_REGISTRY/$IMAGE_NAME:debug-${CI_COMMIT_SHA} \
      -t $SCW_REGISTRY/$IMAGE_NAME:debug .

🚑release_debug:
  stage: 🔖release
  extends: .docker_login
  script: |
    buildah push \
      $SCW_REGISTRY/$IMAGE_NAME:debug \
      $SCW_REGISTRY/$IMAGE_NAME:debug-${CI_COMMIT_SHA}
