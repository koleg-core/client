variables:
  BUILDAH_FORMAT: docker
  REGISTRY_AUTH_FILE: auth.json
  IMAGE_NAME: koleg-client

stages:
  - ğŸ³login
  - ğŸ—build
  - ğŸ”–release
  - deploy

.docker_login:
  image: buildah/buildah:latest
  before_script:
   - >
     echo "$SCW_REGISTRY_TOKEN"
     | buildah login -u "$SCW_REGISTRY_USER" --password-stdin $SCW_REGISTRY

ğŸ”¥build_prod:
  stage: ğŸ—build
  extends: .docker_login
  script: |
    buildah bud \
      --storage-driver "vfs" \
      --build-arg='PROD=true' \
      -t $SCW_REGISTRY/$IMAGE_NAME:${CI_COMMIT_SHA} \
      -t $SCW_REGISTRY/$IMAGE_NAME:latest .

ğŸ”¥release_prod:
  stage: ğŸ”–release
  extends: .docker_login
  script: |
    export STORAGE_DRIVER
    buildah push \
      $SCW_REGISTRY/$IMAGE_NAME:latest \
      $SCW_REGISTRY/$IMAGE_NAME:${CI_COMMIT_SHA}

ğŸš‘build_debug:
  stage: ğŸ—build
  extends: .docker_login
  script: |
    buildah bud \
      --storage-driver "vfs" \
      --build-arg='PROD=false' \
      -t $SCW_REGISTRY/$IMAGE_NAME:debug-${CI_COMMIT_SHA} \
      -t $SCW_REGISTRY/$IMAGE_NAME:debug .

ğŸš‘release_debug:
  stage: ğŸ”–release
  extends: .docker_login
  script: |
    buildah push \
      $SCW_REGISTRY/$IMAGE_NAME:debug \
      $SCW_REGISTRY/$IMAGE_NAME:debug-${CI_COMMIT_SHA}
